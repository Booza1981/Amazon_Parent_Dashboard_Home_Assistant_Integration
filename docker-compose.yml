version: '3.8'

services:
  amazon-dashboard:
    build: .
    container_name: amazon-parental-dashboard
    restart: unless-stopped
    
    environment:
      # MQTT Broker Configuration
      MQTT_BROKER: "192.168.1.100"     # Your MQTT broker IP
      MQTT_PORT: "1883"
      MQTT_USERNAME: "mqtt-user"       # Set if your broker requires auth
      MQTT_PASSWORD: "your-password"   # Set if your broker requires auth
      
      # Child Configuration
      CHILD_NAME: "child"              # Friendly name for MQTT topics
      
      # Sync Interval
      SYNC_INTERVAL: "300"             # Sync every 5 minutes (300 seconds)
    
    volumes:
      # Mount cookies.json to persist authentication (read-write so container can update)
      - ./amazon_parental/cookies.json:/app/amazon_parental/cookies.json
      
      # Optional: Mount config file
      # - ./config.yaml:/app/config.yaml:ro
    
    ports:
      # Expose Flask web UI for cookie management
      - "5000:5000"
    
    networks:
      - homeassistant
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  homeassistant:
    external: false

# Usage:
# 1. Update environment variables above with your MQTT broker details
# 2. Ensure amazon_parental/cookies.json exists (run: python amazon_parental/refresh_cookies.py)
# 3. Build and start: docker-compose up -d
# 4. View logs: docker-compose logs -f
# 5. Cookie Management Web UI: http://YOUR_IP:5000
# 6. Stop: docker-compose down
#
# Cookie Management:
# - Cookies are automatically saved after successful API calls
# - Auto-refresh triggered when cookies are expiring (< 4 hours)
# - Manual refresh via web UI: http://YOUR_IP:5000
# - Upload new cookies via web UI if auto-refresh fails
